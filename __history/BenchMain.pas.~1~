unit BenchMain;

interface

procedure RunFromArgs(const Mode: string);

implementation

uses
  System.SysUtils,
  MemStats,
  MemTouch,
  StartupIO;

function MB(x: UInt64): Double;
begin
  Result := x / 1024 / 1024;
end;

procedure LogWS(const Tag: string);
var
  ws, pf: UInt64;
begin
  if GetWSAndPF(ws, pf) then
    Writeln(Format('%s | WS=%.1fMB | PF=%d', [Tag, MB(ws), pf]))
  else
    Writeln(Tag + ' | GetWSAndPF failed');
end;

procedure RunMem(ReadWrite: Boolean);
begin
  LogWS('before');
  Touch512MB(ReadWrite, 4096); // stride=4KB（ページ）
  LogWS('after');
end;

procedure RunIO;
begin
  LogWS('before');
  RunStartupIO;
  LogWS('after');
end;

procedure RunFromArgs(const Mode: string);
var
  m: string;
begin
  m := LowerCase(Trim(Mode));

  if (m = '') or (m = 'help') then
  begin
    Writeln('Usage: ws_probe_delphi.exe mem_ro | mem_rw | io');
    Exit;
  end;

  if m = 'mem_ro' then
    RunMem(False)
  else if m = 'mem_rw' then
    RunMem(True)
  else if m = 'io' then
    RunIO
  else
    Writeln('Unknown mode: ' + Mode);
end;

end.

